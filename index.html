<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>支付宝支付 - H5支付页面</title>
    <link rel="stylesheet" href="styles.css">
</head>
<body>
    <div class="container">
        <!-- 系统配置完成状态 -->
        <div class="success-banner">
            <div class="success-icon">✅</div>
            <div class="success-content">
                <h2>🎉 支付宝H5支付系统配置完成！</h2>
                <div class="success-details">
                    <p><strong>✓ 支付宝SDK集成完成</strong> - 使用官方Python SDK，支持RSA2签名验证</p>
                    <p><strong>✓ 沙盒环境配置完成</strong> - 已连接支付宝开放平台沙盒环境</p>
                    <p><strong>✓ 支付流程测试通过</strong> - 订单创建、支付跳转、结果回调全流程正常</p>
                    <p><strong>✓ 路由配置优化完成</strong> - 修复静态文件路由冲突，确保API路由优先级</p>
                    <p><strong>✓ 部署配置就绪</strong> - 支持本地开发和Render平台部署</p>
                </div>
                <div class="test-result">
                    <span class="test-badge">最新测试结果</span>
                    <span class="test-status">支付成功 ✓</span>
                    <span class="test-time">订单号: ORDER_1756806352781_9608</span>
                </div>
            </div>
        </div>

        <div class="header">
            <h1>💰 支付宝H5支付</h1>
            <p>安全、便捷的移动支付体验</p>
        </div>

        <!-- 配置参数区域 -->
        <div class="config-section">
            <h3>⚙️ 支付宝配置参数</h3>
            <div class="config-toggle">
                <button type="button" id="toggleConfig" class="toggle-btn">显示配置</button>
            </div>
            <div class="config-form" id="configForm" style="display: none;">
                <div class="form-group">
                    <label for="app_id">应用ID (app_id) *</label>
                    <input type="text" id="app_id" placeholder="请输入支付宝应用ID" required>
                    <small>从支付宝开放平台获取的应用APPID</small>
                </div>
                <div class="form-group">
                    <label for="private_key">商户私钥 (private_key) *</label>
                    <textarea id="private_key" placeholder="请输入RSA2私钥内容" rows="4" required></textarea>
                    <small>应用私钥，用于签名验证（请妥善保管）</small>
                </div>
                <div class="form-group">
                    <label for="alipay_public_key">支付宝公钥 (alipay_public_key) *</label>
                    <textarea id="alipay_public_key" placeholder="请输入支付宝公钥内容" rows="4" required></textarea>
                    <small>支付宝公钥，用于验证支付宝返回的数据</small>
                </div>
                <div class="form-group">
                    <label for="notify_url">异步通知地址 (notify_url)</label>
                    <input type="url" id="notify_url" placeholder="http://localhost:8000/api/alipay/notify" value="http://localhost:8000/api/alipay/notify">
                    <small>支付宝异步通知回调地址</small>
                </div>
                <div class="form-group">
                    <label for="return_url">同步跳转地址 (return_url)</label>
                    <input type="url" id="return_url" placeholder="https://alipaytest.onrender.com/payment/result" value="https://alipaytest.onrender.com/payment/result">
                    <small>支付完成后的页面跳转地址</small>
                </div>
                <div class="form-group">
                    <label for="gateway">支付网关</label>
                    <select id="gateway">
                        <option value="https://openapi.alipaydev.com/gateway.do">沙箱环境</option>
                        <option value="https://openapi.alipay.com/gateway.do">正式环境</option>
                    </select>
                    <small>选择支付宝网关环境</small>
                </div>
                <div class="config-actions">
                    <button type="button" id="saveConfig" class="save-config-btn">保存配置</button>
                    <button type="button" id="loadConfig" class="load-config-btn">加载配置</button>
                    <button type="button" id="clearConfig" class="clear-config-btn">清空配置</button>
                </div>
            </div>
        </div>
        
        <div class="payment-form">
            <div class="order-info">
                <h3>📋 订单信息</h3>
                <div class="form-group">
                    <label for="subject">商品名称</label>
                    <input type="text" id="subject" placeholder="请输入商品名称" value="测试商品">
                </div>
                <div class="form-group">
                    <label for="amount">支付金额 (元)</label>
                    <input type="number" id="amount" placeholder="0.01" value="0.01" min="0.01" step="0.01">
                </div>
                <div class="form-group">
                    <label for="out_trade_no">商户订单号</label>
                    <input type="text" id="out_trade_no" placeholder="自动生成" readonly>
                </div>
            </div>
            
            <div class="payment-methods">
                <h2>支付方式</h2>
                <div class="payment-option selected" data-method="alipay">
                    <img src="data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iNDAiIGhlaWdodD0iNDAiIHZpZXdCb3g9IjAgMCA0MCA0MCIgZmlsbD0ibm9uZSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KPHJlY3Qgd2lkdGg9IjQwIiBoZWlnaHQ9IjQwIiByeD0iOCIgZmlsbD0iIzAwOUZFOCIvPgo8cGF0aCBkPSJNMTIgMTZIMjhWMjRIMTJWMTZaIiBmaWxsPSJ3aGl0ZSIvPgo8cGF0aCBkPSJNMTYgMjBIMjQiIHN0cm9rZT0iIzAwOUZFOCIgc3Ryb2tlLXdpZHRoPSIyIi8+CjwvcGF0aD4KPC9zdmc+" alt="支付宝">
                    <span>支付宝支付</span>
                    <div class="check-icon">✓</div>
                </div>
            </div>
            
            <div class="payment-actions">
                <button id="payBtn" class="pay-button">立即支付</button>
            </div>
        </div>
        
        <div class="result-area" id="resultArea" style="display: none;">
            <h2>支付结果</h2>
            <div id="resultContent"></div>
        </div>
        
        <div class="config-info">
            <h2>配置说明</h2>
            <p>请在 <code>config.js</code> 文件中配置您的支付宝应用信息</p>
            <ul>
                <li>应用ID (app_id)</li>
                <li>商户私钥 (private_key)</li>
                <li>支付宝公钥 (alipay_public_key)</li>
                <li>回调地址 (notify_url, return_url)</li>
            </ul>
        </div>
    </div>
    
    <script src="config.js"></script>
    <script src="alipay.js"></script>
    <script src="main.js"></script>
    
    <script>
        // 检查支付返回结果
        function checkPaymentReturn() {
            const urlParams = new URLSearchParams(window.location.search);
            if (urlParams.has('out_trade_no')) {
                const result = {
                    out_trade_no: urlParams.get('out_trade_no'),
                    trade_no: urlParams.get('trade_no'),
                    total_amount: urlParams.get('total_amount'),
                    trade_status: urlParams.get('trade_status')
                };
                
                console.log('支付返回结果:', result);
                
                // 显示支付结果
                const resultDiv = document.createElement('div');
                resultDiv.innerHTML = `
                    <h3>支付结果</h3>
                    <p>订单号: ${result.out_trade_no}</p>
                    <p>交易号: ${result.trade_no}</p>
                    <p>金额: ${result.total_amount}</p>
                    <p>状态: ${result.trade_status}</p>
                `;
                document.body.appendChild(resultDiv);
            }
        }
        
        // 添加调试按钮
        function addDebugButton() {
            const debugBtn = document.createElement('button');
            debugBtn.textContent = '测试支付请求';
            debugBtn.style.cssText = 'margin: 10px; padding: 10px; background: #ff6600; color: white; border: none; border-radius: 4px;';
            debugBtn.onclick = async function() {
                try {
                    console.log('开始测试支付请求...');
                    const response = await fetch('/api/alipay/create_order', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({
                            subject: '测试商品',
                            total_amount: 0.01,
                            out_trade_no: 'TEST' + Date.now()
                        })
                    });
                    const result = await response.json();
                    console.log('支付请求响应:', result);
                    if (result.success && result.data.pay_url) {
                        console.log('跳转到支付页面:', result.data.pay_url);
                        window.location.href = result.data.pay_url;
                    } else {
                        alert('支付请求失败: ' + (result.message || '未知错误'));
                    }
                } catch (error) {
                    console.error('支付请求错误:', error);
                    alert('支付请求错误: ' + error.message);
                }
            };
            document.querySelector('.payment-form').appendChild(debugBtn);
        }
        
        // 页面加载时检查支付返回并添加调试按钮
        window.onload = function() {
            checkPaymentReturn();
            addDebugButton();
        };
    </script>
</body>
</html>