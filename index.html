<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ”¯ä»˜å®æ”¯ä»˜ - H5æ”¯ä»˜é¡µé¢</title>
    <link rel="stylesheet" href="styles.css">
</head>
<body>
    <div class="container">
        <!-- ç³»ç»Ÿé…ç½®å®ŒæˆçŠ¶æ€ -->
        <div class="success-banner">
            <div class="success-icon">âœ…</div>
            <div class="success-content">
                <h2>ğŸ‰ æ”¯ä»˜å®H5æ”¯ä»˜ç³»ç»Ÿé…ç½®å®Œæˆï¼</h2>
                <div class="success-details">
                    <p><strong>âœ“ æ”¯ä»˜å®SDKé›†æˆå®Œæˆ</strong> - ä½¿ç”¨å®˜æ–¹Python SDKï¼Œæ”¯æŒRSA2ç­¾åéªŒè¯</p>
                    <p><strong>âœ“ æ²™ç›’ç¯å¢ƒé…ç½®å®Œæˆ</strong> - å·²è¿æ¥æ”¯ä»˜å®å¼€æ”¾å¹³å°æ²™ç›’ç¯å¢ƒ</p>
                    <p><strong>âœ“ æ”¯ä»˜æµç¨‹æµ‹è¯•é€šè¿‡</strong> - è®¢å•åˆ›å»ºã€æ”¯ä»˜è·³è½¬ã€ç»“æœå›è°ƒå…¨æµç¨‹æ­£å¸¸</p>
                    <p><strong>âœ“ è·¯ç”±é…ç½®ä¼˜åŒ–å®Œæˆ</strong> - ä¿®å¤é™æ€æ–‡ä»¶è·¯ç”±å†²çªï¼Œç¡®ä¿APIè·¯ç”±ä¼˜å…ˆçº§</p>
                    <p><strong>âœ“ éƒ¨ç½²é…ç½®å°±ç»ª</strong> - æ”¯æŒæœ¬åœ°å¼€å‘å’ŒRenderå¹³å°éƒ¨ç½²</p>
                </div>
                <div class="test-result">
                    <span class="test-badge">æœ€æ–°æµ‹è¯•ç»“æœ</span>
                    <span class="test-status">æ”¯ä»˜æˆåŠŸ âœ“</span>
                    <span class="test-time">è®¢å•å·: ORDER_1756806352781_9608</span>
                </div>
            </div>
        </div>

        <div class="header">
            <h1>ğŸ’° æ”¯ä»˜å®H5æ”¯ä»˜</h1>
            <p>å®‰å…¨ã€ä¾¿æ·çš„ç§»åŠ¨æ”¯ä»˜ä½“éªŒ</p>
        </div>

        <!-- é…ç½®å‚æ•°åŒºåŸŸ -->
        <div class="config-section">
            <h3>âš™ï¸ æ”¯ä»˜å®é…ç½®å‚æ•°</h3>
            <div class="config-toggle">
                <button type="button" id="toggleConfig" class="toggle-btn">æ˜¾ç¤ºé…ç½®</button>
            </div>
            <div class="config-form" id="configForm" style="display: none;">
                <div class="form-group">
                    <label for="app_id">åº”ç”¨ID (app_id) *</label>
                    <input type="text" id="app_id" placeholder="è¯·è¾“å…¥æ”¯ä»˜å®åº”ç”¨ID" required>
                    <small>ä»æ”¯ä»˜å®å¼€æ”¾å¹³å°è·å–çš„åº”ç”¨APPID</small>
                </div>
                <div class="form-group">
                    <label for="private_key">å•†æˆ·ç§é’¥ (private_key) *</label>
                    <textarea id="private_key" placeholder="è¯·è¾“å…¥RSA2ç§é’¥å†…å®¹" rows="4" required></textarea>
                    <small>åº”ç”¨ç§é’¥ï¼Œç”¨äºç­¾åéªŒè¯ï¼ˆè¯·å¦¥å–„ä¿ç®¡ï¼‰</small>
                </div>
                <div class="form-group">
                    <label for="alipay_public_key">æ”¯ä»˜å®å…¬é’¥ (alipay_public_key) *</label>
                    <textarea id="alipay_public_key" placeholder="è¯·è¾“å…¥æ”¯ä»˜å®å…¬é’¥å†…å®¹" rows="4" required></textarea>
                    <small>æ”¯ä»˜å®å…¬é’¥ï¼Œç”¨äºéªŒè¯æ”¯ä»˜å®è¿”å›çš„æ•°æ®</small>
                </div>
                <div class="form-group">
                    <label for="notify_url">å¼‚æ­¥é€šçŸ¥åœ°å€ (notify_url)</label>
                    <input type="url" id="notify_url" placeholder="http://localhost:8000/api/alipay/notify" value="http://localhost:8000/api/alipay/notify">
                    <small>æ”¯ä»˜å®å¼‚æ­¥é€šçŸ¥å›è°ƒåœ°å€</small>
                </div>
                <div class="form-group">
                    <label for="return_url">åŒæ­¥è·³è½¬åœ°å€ (return_url)</label>
                    <input type="url" id="return_url" placeholder="https://alipaytest.onrender.com/payment/result" value="https://alipaytest.onrender.com/payment/result">
                    <small>æ”¯ä»˜å®Œæˆåçš„é¡µé¢è·³è½¬åœ°å€</small>
                </div>
                <div class="form-group">
                    <label for="gateway">æ”¯ä»˜ç½‘å…³</label>
                    <select id="gateway">
                        <option value="https://openapi.alipaydev.com/gateway.do">æ²™ç®±ç¯å¢ƒ</option>
                        <option value="https://openapi.alipay.com/gateway.do">æ­£å¼ç¯å¢ƒ</option>
                    </select>
                    <small>é€‰æ‹©æ”¯ä»˜å®ç½‘å…³ç¯å¢ƒ</small>
                </div>
                <div class="config-actions">
                    <button type="button" id="saveConfig" class="save-config-btn">ä¿å­˜é…ç½®</button>
                    <button type="button" id="loadConfig" class="load-config-btn">åŠ è½½é…ç½®</button>
                    <button type="button" id="clearConfig" class="clear-config-btn">æ¸…ç©ºé…ç½®</button>
                </div>
            </div>
        </div>
        
        <div class="payment-form">
            <div class="order-info">
                <h3>ğŸ“‹ è®¢å•ä¿¡æ¯</h3>
                <div class="form-group">
                    <label for="subject">å•†å“åç§°</label>
                    <input type="text" id="subject" placeholder="è¯·è¾“å…¥å•†å“åç§°" value="æµ‹è¯•å•†å“">
                </div>
                <div class="form-group">
                    <label for="amount">æ”¯ä»˜é‡‘é¢ (å…ƒ)</label>
                    <input type="number" id="amount" placeholder="0.01" value="0.01" min="0.01" step="0.01">
                </div>
                <div class="form-group">
                    <label for="out_trade_no">å•†æˆ·è®¢å•å·</label>
                    <input type="text" id="out_trade_no" placeholder="è‡ªåŠ¨ç”Ÿæˆ" readonly>
                </div>
            </div>
            
            <div class="payment-methods">
                <h2>æ”¯ä»˜æ–¹å¼</h2>
                <div class="payment-option selected" data-method="alipay">
                    <img src="data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iNDAiIGhlaWdodD0iNDAiIHZpZXdCb3g9IjAgMCA0MCA0MCIgZmlsbD0ibm9uZSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KPHJlY3Qgd2lkdGg9IjQwIiBoZWlnaHQ9IjQwIiByeD0iOCIgZmlsbD0iIzAwOUZFOCIvPgo8cGF0aCBkPSJNMTIgMTZIMjhWMjRIMTJWMTZaIiBmaWxsPSJ3aGl0ZSIvPgo8cGF0aCBkPSJNMTYgMjBIMjQiIHN0cm9rZT0iIzAwOUZFOCIgc3Ryb2tlLXdpZHRoPSIyIi8+CjwvcGF0aD4KPC9zdmc+" alt="æ”¯ä»˜å®">
                    <span>æ”¯ä»˜å®æ”¯ä»˜</span>
                    <div class="check-icon">âœ“</div>
                </div>
            </div>
            
            <div class="payment-actions">
                <button id="payBtn" class="pay-button">ç«‹å³æ”¯ä»˜</button>
            </div>
        </div>
        
        <div class="result-area" id="resultArea" style="display: none;">
            <h2>æ”¯ä»˜ç»“æœ</h2>
            <div id="resultContent"></div>
        </div>
        
        <div class="config-info">
            <h2>é…ç½®è¯´æ˜</h2>
            <p>è¯·åœ¨ <code>config.js</code> æ–‡ä»¶ä¸­é…ç½®æ‚¨çš„æ”¯ä»˜å®åº”ç”¨ä¿¡æ¯</p>
            <ul>
                <li>åº”ç”¨ID (app_id)</li>
                <li>å•†æˆ·ç§é’¥ (private_key)</li>
                <li>æ”¯ä»˜å®å…¬é’¥ (alipay_public_key)</li>
                <li>å›è°ƒåœ°å€ (notify_url, return_url)</li>
            </ul>
        </div>
    </div>
    
    <script src="config.js"></script>
    <script src="alipay.js"></script>
    <script src="main.js"></script>
    
    <script>
        // æ£€æŸ¥æ”¯ä»˜è¿”å›ç»“æœ
        function checkPaymentReturn() {
            const urlParams = new URLSearchParams(window.location.search);
            if (urlParams.has('out_trade_no')) {
                const result = {
                    out_trade_no: urlParams.get('out_trade_no'),
                    trade_no: urlParams.get('trade_no'),
                    total_amount: urlParams.get('total_amount'),
                    trade_status: urlParams.get('trade_status')
                };
                
                console.log('æ”¯ä»˜è¿”å›ç»“æœ:', result);
                
                // æ˜¾ç¤ºæ”¯ä»˜ç»“æœ
                const resultDiv = document.createElement('div');
                resultDiv.innerHTML = `
                    <h3>æ”¯ä»˜ç»“æœ</h3>
                    <p>è®¢å•å·: ${result.out_trade_no}</p>
                    <p>äº¤æ˜“å·: ${result.trade_no}</p>
                    <p>é‡‘é¢: ${result.total_amount}</p>
                    <p>çŠ¶æ€: ${result.trade_status}</p>
                `;
                document.body.appendChild(resultDiv);
            }
        }
        
        // æ·»åŠ è°ƒè¯•æŒ‰é’®
        function addDebugButton() {
            const debugBtn = document.createElement('button');
            debugBtn.textContent = 'æµ‹è¯•æ”¯ä»˜è¯·æ±‚';
            debugBtn.style.cssText = 'margin: 10px; padding: 10px; background: #ff6600; color: white; border: none; border-radius: 4px;';
            debugBtn.onclick = async function() {
                try {
                    console.log('å¼€å§‹æµ‹è¯•æ”¯ä»˜è¯·æ±‚...');
                    const response = await fetch('/api/alipay/create_order', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({
                            subject: 'æµ‹è¯•å•†å“',
                            total_amount: 0.01,
                            out_trade_no: 'TEST' + Date.now()
                        })
                    });
                    const result = await response.json();
                    console.log('æ”¯ä»˜è¯·æ±‚å“åº”:', result);
                    if (result.success && result.data.pay_url) {
                        console.log('è·³è½¬åˆ°æ”¯ä»˜é¡µé¢:', result.data.pay_url);
                        window.location.href = result.data.pay_url;
                    } else {
                        alert('æ”¯ä»˜è¯·æ±‚å¤±è´¥: ' + (result.message || 'æœªçŸ¥é”™è¯¯'));
                    }
                } catch (error) {
                    console.error('æ”¯ä»˜è¯·æ±‚é”™è¯¯:', error);
                    alert('æ”¯ä»˜è¯·æ±‚é”™è¯¯: ' + error.message);
                }
            };
            document.querySelector('.payment-form').appendChild(debugBtn);
        }
        
        // é¡µé¢åŠ è½½æ—¶æ£€æŸ¥æ”¯ä»˜è¿”å›å¹¶æ·»åŠ è°ƒè¯•æŒ‰é’®
        window.onload = function() {
            checkPaymentReturn();
            addDebugButton();
        };
    </script>
</body>
</html>